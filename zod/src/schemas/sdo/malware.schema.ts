import { z } from "zod";
import { stixTypeSchema } from "../common/stix-type";
import { softwareSchema } from "./software.schema";
import { createStixIdentifierSchema, killChainPhaseSchema, stixIdentifierSchema, stixTimestampSchema } from "../common";
import { MalwareCapabilitiesOpenVocabulary, ProcessorArchitecturesOpenVocabulary, ImplementationLanguagesOpenVocabulary, MalwareTypeOpenVocabulary } from "../common/open-vocabulary";

// Initializes the custom ZodErrorMap
// TODO migrate to loading this in a globally scoped module
import '../../errors'; 


export const malwareSchema = softwareSchema.extend({

    id: createStixIdentifierSchema(stixTypeSchema.enum.malware),

    type: z.literal(stixTypeSchema.enum.malware),

    is_family: z
        .boolean()
        .describe("Whether the object represents a malware family (if true) or a malware instance (if false)"),

    // Not used in ATT&CK Malware but defined in STIX
    malware_types: z
        .array(MalwareTypeOpenVocabulary)
        .describe('A set of categorizations for the malware being described.')
        .optional(),

    // Not used in ATT&CK Malware but defined in STIX
    kill_chain_phases: z
        .array(killChainPhaseSchema)
        .describe('The list of Kill Chain Phases for which this malware can be used.')
        .optional(),

    // Not used in ATT&CK Malware but defined in STIX
    first_seen: stixTimestampSchema
        .optional()
        .describe("The time that this malware instance or malware family was first seen."),
    
    // Not used in ATT&CK Malware but defined in STIX
    last_seen: stixTimestampSchema
        .optional()
        .describe("The time that this malware family or malware instance was last seen."),

    // Not used in ATT&CK Malware but defined in STIX
    os_execution_envs : z
        .array(z.string())
        .describe('The operating systems that the malware family or malware instance is executable on. This applies to virtualized operating systems as well as those running on bare metal.')
        .optional(),
    
    // Not used in ATT&CK Malware but defined in STIX
    architecture_execution_envs: z
        .array(ProcessorArchitecturesOpenVocabulary)
        .describe('The processor architectures (e.g., x86, ARM, etc.) that the malware instance or family is executable on.')
        .optional(),
    
    // Not used in ATT&CK Malware but defined in STIX
    implementation_languages: z
        .array(ImplementationLanguagesOpenVocabulary)
        .describe('The programming language(s) used to implement the malware instance or family.')
        .optional(),
    
    // Not used in ATT&CK Malware but defined in STIX
    capabilities: z
        .array(MalwareCapabilitiesOpenVocabulary)
        .describe('Any of the capabilities identified for the malware instance or family.')
        .optional(),

    // Not used in ATT&CK Malware but defined in STIX
    sample_refs: z
        .array(stixIdentifierSchema)
        .optional()
        .describe('The sample_refs property specifies a list of identifiers of the SCO file or artifact objects associated with this malware instance(s) or family.')
})
.refine(schemas => {
    // The object's name MUST be listed as the first alias in the x_mitre_aliases field
    if (schemas.x_mitre_aliases && schemas.x_mitre_aliases.length > 0) {
        return schemas.x_mitre_aliases[0] === schemas.name;
    }
    return true;
    },
    {
        message: "The first alias must match the object's name",
        path: ['x_mitre_aliases']
    }
);

// Define the type for Malware
export type Malware = z.infer<typeof malwareSchema>;